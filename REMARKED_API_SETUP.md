# Настройка ReMarked API для бронирования столиков

## Обзор

Интеграция с ReMarked API позволяет использовать систему бронирования столиков для ресторанов. API работает через внешний сервис ReMarked без необходимости настройки переменных окружения на сервере.

## Что нужно для работы

### 1. ReMarked Point ID для каждого ресторана

**Важно**: Для работы бронирования необходимо указать **ReMarked Point ID** для каждого ресторана через админ-панель.

**ReMarked Point ID** - это уникальный идентификатор заведения в системе ReMarked. Этот ID получается при регистрации заведения в системе ReMarked.

### Как получить ReMarked Point ID

1. Зарегистрируйте заведение в системе ReMarked (https://app.remarked.ru)
2. После регистрации вы получите **Point ID** (например: `7999999`)
3. Этот ID нужно указать в админ-панели при создании или редактировании ресторана

### Где указать ReMarked Point ID

1. Войдите в админ-панель как администратор
2. Перейдите в раздел "Управление ресторанами"
3. Создайте новый ресторан или отредактируйте существующий
4. В форме найдите поле **"ReMarked Point ID (для бронирования столиков)"**
5. Введите ID заведения (например: `7999999`)
6. Сохраните изменения

## Переменные окружения

**Важно**: Для работы ReMarked API **НЕ требуются** переменные окружения на сервере.

Все необходимые данные (Point ID) хранятся в базе данных для каждого ресторана отдельно. Это позволяет:
- Использовать разные Point ID для разных ресторанов
- Легко добавлять новые рестораны без изменения конфигурации сервера
- Управлять настройками через админ-панель

## Структура данных

### Модель Restaurant

В базе данных добавлено поле `remarkedPointId`:

```typescript
@Column({ nullable: true })
remarkedPointId?: number;  // ID заведения в системе ReMarked
```

Это поле:
- Опциональное (может быть `null`)
- Хранится в базе данных для каждого ресторана
- Редактируется через админ-панель

## Процесс работы

### 1. Создание бронирования

Когда пользователь создает бронирование:

1. Система получает `restaurantId` из запроса
2. Загружает ресторан из базы данных
3. Проверяет наличие `remarkedPointId`
4. Если `remarkedPointId` отсутствует - возвращает ошибку
5. Если `remarkedPointId` есть:
   - Получает токен от ReMarked API используя `remarkedPointId`
   - Создает бронирование через ReMarked API
   - Возвращает результат пользователю

### 2. Обработка ошибок

Система обрабатывает следующие случаи:

- **Ресторан не найден**: `404` - Ресторан не существует в базе
- **Ресторан неактивен**: `400` - Ресторан деактивирован
- **ReMarked Point ID не указан**: `400` - Ресторан не настроен для бронирования
- **Ошибка получения токена**: `500` - Проблема с подключением к ReMarked API
- **Ошибка создания бронирования**: `400/500` - Неверные данные или проблема с API

## Примеры использования

### Создание бронирования через API

```bash
POST /api/booking
Authorization: Bearer <token>
Content-Type: application/json

{
  "restaurantId": "uuid-ресторана",
  "name": "Иван Иванов",
  "phone": "+79189999999",
  "email": "ivan@example.com",
  "date": "2024-06-25",
  "time": "14:00",
  "guests_count": 4,
  "duration": 120,
  "comment": "У окна, пожалуйста"
}
```

### Успешный ответ

```json
{
  "success": true,
  "data": {
    "reserve_id": 1234567890,
    "form_url": "https://payment.example.com/form/...",
    "message": "Бронирование создано. Перейдите по ссылке для оплаты депозита."
  }
}
```

### Ошибка: ReMarked Point ID не указан

```json
{
  "success": false,
  "message": "Ресторан не настроен для бронирования. Обратитесь к администратору."
}
```

## Настройка через админ-панель

### Шаг 1: Вход в админ-панель

1. Войдите в систему как администратор
2. Перейдите в раздел "Управление ресторанами"

### Шаг 2: Создание/редактирование ресторана

1. Нажмите "Добавить ресторан" или "Редактировать" для существующего
2. Заполните основные данные ресторана
3. Найдите поле **"ReMarked Point ID (для бронирования столиков)"**
4. Введите ID заведения (число, например: `7999999`)
5. Сохраните изменения

### Шаг 3: Проверка

После сохранения:
- ReMarked Point ID будет отображаться в списке ресторанов
- Бронирование для этого ресторана будет работать

## Миграция базы данных

Если вы обновляете существующую базу данных, необходимо выполнить миграцию для добавления поля `remarkedPointId`:

```sql
ALTER TABLE restaurants 
ADD COLUMN "remarkedPointId" integer;
```

Или используйте TypeORM миграции:

```typescript
// migration файл
public async up(queryRunner: QueryRunner): Promise<void> {
  await queryRunner.addColumn('restaurants', new TableColumn({
    name: 'remarkedPointId',
    type: 'integer',
    isNullable: true,
  }));
}
```

## Проверка работы

### Тест 1: Проверка наличия Point ID

```bash
GET /api/admin/restaurants
Authorization: Bearer <admin-token>
```

Проверьте, что в ответе у ресторана есть поле `remarkedPointId`.

### Тест 2: Создание тестового бронирования

```bash
POST /api/booking
Authorization: Bearer <user-token>
Content-Type: application/json

{
  "restaurantId": "<uuid-ресторана-с-point-id>",
  "name": "Test User",
  "phone": "+79189999999",
  "date": "2024-12-31",
  "time": "12:00",
  "guests_count": 2
}
```

Если все настроено правильно, вы получите успешный ответ с `reserve_id`.

## Устранение проблем

### Проблема: "Ресторан не настроен для бронирования"

**Причина**: У ресторана не указан `remarkedPointId`

**Решение**: 
1. Войдите в админ-панель
2. Отредактируйте ресторан
3. Укажите ReMarked Point ID
4. Сохраните изменения

### Проблема: "Не удалось подключиться к сервису бронирования"

**Причина**: 
- Неверный ReMarked Point ID
- Проблемы с сетью
- ReMarked API недоступен

**Решение**:
1. Проверьте правильность ReMarked Point ID
2. Проверьте доступность ReMarked API (https://app.remarked.ru/api/v1)
3. Проверьте логи сервера для деталей ошибки

### Проблема: "Неверные данные для бронирования"

**Причина**: Неверный формат данных в запросе

**Решение**:
- Проверьте формат телефона: должен начинаться с `+` (например: `+79189999999`)
- Проверьте формат даты: `YYYY-MM-DD` (например: `2024-06-25`)
- Проверьте формат времени: `HH:mm` (например: `14:00`)
- Убедитесь, что `guests_count` - это число

## Дополнительная информация

- **Документация API ReMarked**: См. `REMARKED_API_ANALYSIS.md`
- **Типы TypeScript**: `backend/src/types/remarked.ts`
- **Сервис для работы с API**: `backend/src/services/remarkedService.ts`
- **Краткая справка**: `REMARKED_API_QUICK_REFERENCE.md`

## Резюме

✅ **Не требуется** настройка переменных окружения  
✅ **Требуется** указать ReMarked Point ID для каждого ресторана через админ-панель  
✅ Все данные хранятся в базе данных  
✅ Легко управляется через веб-интерфейс  

Для начала работы просто укажите ReMarked Point ID для ваших ресторанов в админ-панели!
