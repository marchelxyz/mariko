# Исправления для корректной работы API

## Проблемы, которые были исправлены

### 1. 404 ошибки на API маршрутах
**Проблема:** Запросы шли без префикса `/api`, хотя все маршруты подключены с этим префиксом.

**Исправления:**
- ✅ Обновлен `frontend/lib/api.ts` - автоматически добавляет `/api` к baseURL если его нет
- ✅ Обновлен `frontend/next.config.js` - fallback теперь включает `/api`
- ✅ Добавлен обработчик 404 в бекенде с информативными сообщениями

### 2. Улучшена обработка ошибок
**Изменения:**
- ✅ Улучшен `backend/src/middleware/errorHandler.ts` - добавлено логирование с контекстом
- ✅ Добавлено логирование всех 404 запросов для отладки
- ✅ Улучшено логирование при запуске сервера

### 3. Улучшены CORS настройки
**Изменения:**
- ✅ Более гибкая настройка CORS с поддержкой нескольких origin
- ✅ Разрешены запросы без origin (для мобильных приложений, Postman)
- ✅ Добавлено логирование заблокированных origin

### 4. Улучшено логирование
**Изменения:**
- ✅ Добавлено логирование окружения при запуске
- ✅ Логирование всех запросов с временными метками
- ✅ Разные форматы логирования для development и production

## Структура API маршрутов

Все маршруты доступны с префиксом `/api`:

- `/api/auth/telegram` - аутентификация через Telegram
- `/api/restaurants` - список ресторанов
- `/api/menu/:restaurantId` - меню ресторана
- `/api/banners` - баннеры
- `/api/profile` - профиль пользователя (требует аутентификации)
- `/api/admin/*` - админ панель (требует роль admin)
- `/api/booking` - бронирование столиков (требует аутентификации)

## Важные настройки для деплоя

### Backend (Railway)
Переменные окружения:
- `DATABASE_URL` - автоматически от PostgreSQL плагина
- `JWT_SECRET` - секретный ключ для JWT
- `FRONTEND_URL` - URL фронтенда (например: `https://your-app.vercel.app`)
- `PORT` - устанавливается автоматически Railway
- `NODE_ENV` - `production` для production окружения

### Frontend (Vercel)
Переменные окружения:
- `NEXT_PUBLIC_API_URL` - URL бекенда с `/api` в конце (например: `https://your-backend.railway.app/api`)

## Проверка работоспособности

1. **Проверка бекенда:**
   ```bash
   curl https://your-backend.railway.app/health
   ```
   Должен вернуть: `{"status":"ok","database":"connected"}`

2. **Проверка API:**
   ```bash
   curl https://your-backend.railway.app/api/restaurants
   ```
   Должен вернуть список ресторанов

3. **Проверка фронтенда:**
   - Откройте DevTools → Network
   - Все запросы должны идти на `/api/*` маршруты
   - Не должно быть 404 ошибок

## Что делать если все еще есть проблемы

1. Проверьте логи бекенда на Railway - там будет видно все запросы
2. Проверьте переменные окружения на Vercel и Railway
3. Убедитесь, что `NEXT_PUBLIC_API_URL` заканчивается на `/api`
4. Проверьте CORS - убедитесь, что `FRONTEND_URL` установлен правильно
5. Проверьте, что все запросы используют `api` из `@/lib/api`
