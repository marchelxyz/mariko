# Извлечение информации о схеме зала из виджета ReMarked

## Описание

Из предоставленного HTML кода виджета ReMarked можно извлечь следующую информацию о схеме зала:

1. **ID точки (Point ID)** - из URL конфигурационных файлов (`203003` в вашем случае)
2. **Конфигурационные файлы** - JavaScript файлы с настройками виджета
3. **CSS файлы** - стили с позициями столов и фоновыми изображениями
4. **Фоновое изображение** - изображение схемы зала
5. **Логотип** - логотип ресторана

## Что можно извлечь

### Из HTML:

- **Point ID**: `203003` (из URL `https://remarked.ru/widget/new/points/203003/config.marico.js`)
- **Конфигурационные файлы**:
  - `https://remarked.ru/widget/new/points/203003/config.marico.js`
  - `https://remarked.ru/widget/new/points/203003/203003.css`
- **Виджеты таблиц**:
  - `https://remarked.ru/widget/new/js/tables/newidget.js`
  - `https://remarked.ru/widget/new/js/tables/Tables.widget.js`
- **Фоновое изображение**: `https://access.clientomer.ru/widget/203003/bg1.png`
- **Логотип**: `https://access.clientomer.ru/widget/203003/logo.png`

### Из конфигурационных файлов:

Конфигурационные файлы могут содержать:
- Список столов с их ID
- Позиции столов (x, y координаты)
- Вместимость столов
- Информацию о залах (rooms)
- Настройки виджета

### Из CSS файлов:

CSS файлы могут содержать:
- Позиции столов через классы `.table-{id}`
- Фоновые изображения залов
- Размеры и формы столов

## Использование скриптов

### Вариант 1: Анализ HTML файла

```bash
# Сохраните HTML в файл
echo '<!DOCTYPE html>...' > widget.html

# Запустите анализ
npx ts-node scripts/analyze-remarked-widget.ts widget.html
```

### Вариант 2: Анализ HTML из строки

```bash
npx ts-node scripts/analyze-remarked-widget.ts --html "<!DOCTYPE html>..."
```

### Вариант 3: Извлечение по Point ID

```bash
# Извлечение данных для точки 203003
npx ts-node scripts/extract-hall-scheme.ts 203003
```

## Результаты

Скрипты создадут файлы в директории `output/`:

1. **widget-analysis.json** - полный анализ виджета
2. **hall-scheme.json** - схема зала в формате для вашей системы

## Формат результата

Результат будет в формате, совместимом с вашей системой:

```json
{
  "hallSchemes": [
    {
      "roomId": "1",
      "roomName": "Основной зал",
      "imageUrl": "https://access.clientomer.ru/widget/203003/bg1.png",
      "tables": [
        {
          "tableId": 330,
          "tableNumber": "1",
          "x": 15,
          "y": 20,
          "capacity": 4,
          "shape": "circle",
          "width": 40,
          "height": 40
        }
      ]
    }
  ]
}
```

## Ограничения

1. **Конфигурационные файлы могут быть минифицированы** - парсинг может быть затруднен
2. **Данные могут быть динамическими** - некоторые данные загружаются через API
3. **Координаты могут быть в разных форматах** - пиксели, проценты, относительные единицы
4. **Требуется доступ к файлам** - файлы должны быть доступны по HTTP/HTTPS

## Рекомендации

### Лучший способ получить полную информацию:

1. **Используйте ReMarked API** - самый надежный источник данных:
   ```typescript
   // Получение слотов с информацией о залах
   const slots = await remarkedService.getSlots(
     token,
     { from: "2024-06-25", to: "2024-06-25" },
     4,
     { with_rooms: true }
   );
   ```

2. **Комбинируйте источники**:
   - API для получения ID столов и залов
   - Конфигурационные файлы для позиций столов
   - CSS для визуального оформления

3. **Ручная настройка координат**:
   - Если автоматическое извлечение не работает, используйте визуальный редактор
   - Загрузите изображение схемы зала
   - Вручную укажите позиции столов

## Интеграция с вашей системой

После извлечения данных, вы можете:

1. **Сохранить в базу данных**:
   ```sql
   UPDATE restaurants 
   SET "hallSchemes" = '[...]'::jsonb
   WHERE "remarkedPointId" = 203003;
   ```

2. **Использовать API синхронизации**:
   ```bash
   POST /restaurants/:id/sync-hall-schemes
   ```

3. **Обновить через админ-панель** (если реализовано)

## Пример использования

```bash
# 1. Сохраните HTML виджета в файл
cat > /tmp/widget.html << 'EOF'
<!DOCTYPE html>
<html lang="ru-RU">
...
</html>
EOF

# 2. Запустите анализ
npx ts-node scripts/analyze-remarked-widget.ts /tmp/widget.html

# 3. Проверьте результаты
cat output/hall-scheme.json

# 4. Используйте данные для обновления ресторана
# (через API или напрямую в БД)
```

## Дополнительная информация

Для получения полной информации о схеме зала рекомендуется:

1. Использовать ReMarked API с параметром `with_rooms: true`
2. Получить информацию о конкретном бронировании через `GetReserveByID`
3. Комбинировать данные из API с визуальными данными из конфигурационных файлов

См. также:
- `HALL_SCHEMES_SETUP.md` - настройка схем залов
- `TABLE_BUNDLES_FEATURE.md` - работа с комбинациями столов
- `REMARKED_API_SETUP.md` - настройка ReMarked API
