# Настройка схем залов для бронирования

## Описание

Система поддерживает отображение интерактивных схем залов при бронировании столиков. Каждый ресторан может иметь свою уникальную схему зала с расположением столов.

## Структура данных

Схемы залов хранятся в поле `hallSchemes` модели `Restaurant` в формате JSONB.

### Пример структуры:

```json
{
  "hallSchemes": [
    {
      "roomId": "19",
      "roomName": "Основной зал",
      "imageUrl": "https://example.com/hall-scheme.jpg",
      "width": 800,
      "height": 600,
      "tables": [
        {
          "tableId": 330,
          "tableNumber": "1",
          "x": 15,
          "y": 20,
          "capacity": 4,
          "shape": "circle",
          "width": 40,
          "height": 40
        },
        {
          "tableId": 331,
          "tableNumber": "2",
          "x": 35,
          "y": 20,
          "capacity": 2,
          "shape": "rectangle",
          "width": 50,
          "height": 30
        }
      ]
    },
    {
      "roomId": "20",
      "roomName": "Веранда",
      "imageUrl": "https://example.com/veranda-scheme.jpg",
      "width": 1000,
      "height": 700,
      "tables": [
        {
          "tableId": 340,
          "tableNumber": "10",
          "x": 25,
          "y": 30,
          "capacity": 6,
          "shape": "circle",
          "width": 45
        }
      ]
    }
  ]
}
```

## Поля схемы зала

### HallScheme (Схема зала)

- `roomId` (string, обязательное) - ID зала в системе ReMarked (должен совпадать с ID из API)
- `roomName` (string, обязательное) - Название зала для отображения
- `imageUrl` (string, опциональное) - URL изображения схемы зала
- `width` (number, опциональное) - Ширина изображения в пикселях (для правильного масштабирования)
- `height` (number, опциональное) - Высота изображения в пикселях (для правильного масштабирования)
- `tables` (array, обязательное) - Массив столов в зале

### TablePosition (Позиция стола)

- `tableId` (number, обязательное) - ID стола в системе ReMarked (должен совпадать с ID из API)
- `tableNumber` (string, обязательное) - Номер стола для отображения на схеме
- `x` (number, обязательное) - Позиция X на схеме в процентах (0-100)
- `y` (number, обязательное) - Позиция Y на схеме в процентах (0-100)
- `capacity` (number, опциональное) - Вместимость стола (количество гостей)
- `shape` (string, опциональное) - Форма стола: `"circle"` или `"rectangle"` (по умолчанию `"circle"`)
- `width` (number, опциональное) - Ширина стола в пикселях (по умолчанию 40px)
- `height` (number, опциональное) - Высота стола в пикселях (по умолчанию равна width для круга)

## Как получить ID залов и столов из ReMarked API

1. Вызовите метод `GetSlots` с параметром `with_rooms: true`
2. В ответе будут доступны `tables_ids` - это ID столов
3. Для получения информации о залах, используйте метод `GetReserveByID` - в ответе будет структура `tables` с `roomId` и `room_name`

Пример запроса:
```typescript
const slots = await remarkedService.getSlots(
  token,
  { from: "2024-06-25", to: "2024-06-25" },
  4,
  { with_rooms: true }
);
```

## Как добавить схему зала для ресторана

### Вариант 1: Через админ-панель (если реализована)

1. Перейдите в раздел управления ресторанами
2. Выберите нужный ресторан
3. Заполните поле "Схемы залов" в формате JSON или используйте визуальный редактор

### Вариант 2: Через базу данных напрямую

```sql
UPDATE restaurants 
SET "hallSchemes" = '[
  {
    "roomId": "19",
    "roomName": "Основной зал",
    "imageUrl": "https://example.com/hall.jpg",
    "width": 800,
    "height": 600,
    "tables": [
      {
        "tableId": 330,
        "tableNumber": "1",
        "x": 15,
        "y": 20,
        "capacity": 4,
        "shape": "circle",
        "width": 40
      }
    ]
  }
]'::jsonb
WHERE id = 'your-restaurant-id';
```

### Вариант 3: Через API (если реализован endpoint для обновления)

```typescript
await api.put(`/restaurants/${restaurantId}`, {
  hallSchemes: [
    {
      roomId: "19",
      roomName: "Основной зал",
      // ... остальные поля
    }
  ]
});
```

## Определение координат столов

### Метод 1: Визуальный редактор

1. Загрузите изображение схемы зала
2. Используйте графический редактор для определения координат
3. Конвертируйте координаты в проценты:
   - `x = (координата_x / ширина_изображения) * 100`
   - `y = (координата_y / высота_изображения) * 100`

### Метод 2: Ручной расчет

Если у вас есть схема зала:
1. Определите размеры изображения (width × height)
2. Для каждого стола определите его позицию в пикселях
3. Конвертируйте в проценты относительно размеров изображения

Пример:
- Изображение: 800px × 600px
- Стол находится на позиции 200px × 150px
- `x = (200 / 800) * 100 = 25%`
- `y = (150 / 600) * 100 = 25%`

## Особенности отображения

1. **Если есть изображение зала**: Столы отображаются поверх изображения
2. **Если нет изображения**: Отображается только схема со столами на сером фоне
3. **Доступные столы**: Зеленым цветом (из списка `tables_ids` из выбранного слота)
4. **Выбранные столы**: Основным цветом (primary) с эффектом масштабирования
5. **Недоступные столы**: Серым цветом с пониженной прозрачностью

## API Endpoints

### Получение схем залов ресторана

```
GET /restaurants/:id/hall-schemes
```

Ответ:
```json
{
  "success": true,
  "data": {
    "restaurantId": "uuid",
    "restaurantName": "Название ресторана",
    "hallSchemes": [...]
  }
}
```

## Интеграция с ReMarked API

Важно: ID столов (`tableId`) и залов (`roomId`) должны совпадать с данными из ReMarked API.

При получении слотов через `/booking/slots` с параметром `with_rooms: true`, система получает список доступных `tables_ids`. Эти ID используются для:
- Подсветки доступных столов на схеме
- Фильтрации недоступных столов
- Валидации выбранных столов при создании бронирования

## Примеры использования

### Простая схема без изображения

```json
{
  "roomId": "19",
  "roomName": "Основной зал",
  "tables": [
    {
      "tableId": 330,
      "tableNumber": "1",
      "x": 20,
      "y": 30,
      "capacity": 4
    }
  ]
}
```

### Схема с изображением и разными формами столов

```json
{
  "roomId": "19",
  "roomName": "Основной зал",
  "imageUrl": "https://example.com/hall.jpg",
  "width": 800,
  "height": 600,
  "tables": [
    {
      "tableId": 330,
      "tableNumber": "1",
      "x": 15,
      "y": 20,
      "capacity": 4,
      "shape": "circle",
      "width": 40
    },
    {
      "tableId": 331,
      "tableNumber": "2",
      "x": 35,
      "y": 20,
      "capacity": 2,
      "shape": "rectangle",
      "width": 50,
      "height": 30
    }
  ]
}
```

## Рекомендации

1. **Изображения**: Используйте оптимизированные изображения (WebP, сжатые JPEG) для быстрой загрузки
2. **Координаты**: Используйте проценты вместо пикселей для адаптивности на разных устройствах
3. **Размеры столов**: Указывайте реалистичные размеры столов для лучшего UX
4. **Вместимость**: Указывайте `capacity` для информативности пользователей
5. **Множественные залы**: Если ресторан имеет несколько залов, создайте отдельную схему для каждого

## Поддержка

При возникновении проблем с настройкой схем залов:
1. Проверьте формат JSON на валидность
2. Убедитесь, что `tableId` совпадают с ID из ReMarked API
3. Проверьте, что координаты находятся в диапазоне 0-100%
4. Убедитесь, что изображения доступны по указанным URL
