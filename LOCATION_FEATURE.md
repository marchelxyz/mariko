# Функционал автоматического выбора ближайшего ресторана

## Описание

Система автоматически определяет местоположение пользователя через Telegram WebApp SDK и выбирает ближайший к нему ресторан при первом входе в приложение.

## Как это работает

1. **Геокодирование адресов ресторанов**: Адреса ресторанов автоматически преобразуются в координаты (latitude, longitude) через Yandex Geocoding API
2. **Запрос местоположения пользователя**: При первом входе приложение запрашивает разрешение на доступ к местоположению через Telegram WebApp SDK
3. **Поиск ближайшего ресторана**: Система вычисляет расстояние до всех ресторанов и выбирает ближайший
4. **Приоритет выбора**: 
   - Избранный ресторан пользователя (если установлен)
   - Ближайший ресторан по местоположению
   - Первый ресторан в списке

## Настройка

### 1. Получение API ключа Yandex Geocoding

1. Перейдите на [Yandex Cloud Console](https://console.cloud.yandex.ru/)
2. Создайте новый проект или выберите существующий
3. Перейдите в раздел "API ключи"
4. Создайте новый API ключ для Geocoding API
5. Скопируйте ключ

### 2. Установка переменной окружения

Добавьте в переменные окружения бэкенда:

```bash
YANDEX_GEOCODING_API_KEY=ваш_api_ключ
```

### 3. Геокодирование существующих ресторанов

После добавления API ключа запустите скрипт для геокодирования всех существующих ресторанов:

```bash
cd backend
npm run geocode-restaurants
```

Скрипт автоматически:
- Найдет все рестораны без координат
- Геокодирует их адреса через Yandex API
- Сохранит координаты в базу данных

### 4. Автоматическое геокодирование новых ресторанов

При создании нового ресторана через админ-панель координаты можно добавить вручную или они будут автоматически геокодированы при следующем запуске скрипта.

## API Endpoints

### GET /api/restaurants/nearest

Находит ближайший ресторан к указанным координатам.

**Параметры запроса:**
- `latitude` (number) - Широта пользователя
- `longitude` (number) - Долгота пользователя

**Пример запроса:**
```bash
GET /api/restaurants/nearest?latitude=53.2001&longitude=45.0046
```

**Ответ:**
```json
{
  "success": true,
  "data": {
    "restaurant": {
      "id": "...",
      "name": "Пенза",
      "city": "Пенза",
      "address": "с. Засечное, Прибережный, 2А",
      "latitude": 53.2001,
      "longitude": 45.0046,
      ...
    },
    "distance": 2.5
  }
}
```

## Использование на фронтенде

### Запрос местоположения пользователя

```typescript
import { requestLocation } from '@/lib/location';

const location = await requestLocation();
if (location) {
  console.log(`Координаты: ${location.latitude}, ${location.longitude}`);
}
```

### Поиск ближайшего ресторана

```typescript
import { useStore } from '@/store/useStore';

const { findNearestRestaurant, selectNearestRestaurantByLocation } = useStore();

// Автоматический выбор ближайшего ресторана
await selectNearestRestaurantByLocation();

// Или вручную по координатам
const nearest = await findNearestRestaurant(53.2001, 45.0046);
```

## Хранение местоположения

Местоположение пользователя сохраняется в `localStorage` после первого запроса, чтобы не запрашивать его каждый раз. Пользователь может в любой момент обновить местоположение, удалив сохраненные данные.

## Обработка ошибок

- Если пользователь отказывается предоставить местоположение, система выберет первый ресторан в списке
- Если API ключ Yandex не установлен, геокодирование будет пропущено с предупреждением в логах
- Если у ресторана нет координат, он не будет учитываться при поиске ближайшего

## Ограничения Yandex Geocoding API

- Бесплатный тариф: до 25,000 запросов в день
- Для больших объемов рекомендуется использовать платный тариф
- Задержка между запросами в скрипте геокодирования: 200мс (чтобы не превысить лимиты)

## Будущие улучшения

- Добавление полей координат в админ-панель для ручного редактирования
- Кнопка "Обновить местоположение" в интерфейсе
- Отображение расстояния до ресторанов в списке
- Кэширование результатов геокодирования
